a7bb83a38df9765642e3fbfe18e21af3
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const doctrine_1 = __importDefault(require("doctrine"));
const fs_1 = __importDefault(require("fs"));
const glob_1 = __importDefault(require("glob"));
const lodash_mergewith_1 = __importDefault(require("lodash.mergewith"));
const path_1 = __importDefault(require("path"));
const yaml_1 = __importDefault(require("yaml"));
class OpenApi {
    constructor(config) {
        this.config = config;
        this.globFilesMatches = (baseDir, filesPattern, excludedFolder = OpenApi.DEFAULT_EXCLUDED_FOLDER) => {
            try {
                const files = glob_1.default.sync(path_1.default.resolve(baseDir, filesPattern), OpenApi.DEFAULT_GLOB_OPTIONS);
                return files.filter((file) => !file.includes(excludedFolder));
            }
            catch (error) {
                throw new Error('Error Glob Files');
            }
        };
        this.getComments = (text) => {
            const comments = text.match(OpenApi.COMMENTS_PATTERN);
            if (comments) {
                const filterComments = comments.filter((comment) => comment.match(OpenApi.BREAK_LINE));
                return filterComments.map((comment) => comment.trim());
            }
            return [];
        };
    }
    readFile(filePath) {
        return fs_1.default.readFileSync(filePath).toString();
    }
    readFiles(files) {
        if (!files || !Array.isArray(files)) {
            return [];
        }
        return files.map((file) => this.readFile(file));
    }
    getOnlyComments(fileContents = []) {
        if (!Array.isArray(fileContents)) {
            return [];
        }
        const comments = fileContents.map((comment) => {
            const trimedComments = comment.trim();
            return this.getComments(trimedComments);
        });
        return [].concat(...comments).filter((comment) => (comment[0] === '/' && comment[1] !== '/'));
    }
    jsdocInfo(comments) {
        if (!comments || !Array.isArray(comments)) {
            return [];
        }
        return comments.map((comment) => {
            const jsDocComment = doctrine_1.default.parse(comment, { unwrap: true });
            return jsDocComment;
        });
    }
    parseYamlComments(jsDoc) {
        const yamlComments = [];
        for (const doc of jsDoc) {
            for (const tag of doc.tags) {
                if (tag.title === 'openapi') {
                    yamlComments.push(tag.description);
                }
            }
        }
        return yamlComments;
    }
    parseJsonCommentsFromYaml(yamlComments) {
        const jsons = [];
        for (const doc of yamlComments) {
            const parsed = yaml_1.default.parseDocument(doc);
            const anchors = parsed.anchors.getNames();
            if (anchors.length) {
                throw new Error('Error parsing YAML comments');
            }
            else if (parsed.errors && parsed.errors.length) {
                throw new Error('Error parsing YAML comments');
            }
            else {
                jsons.push(parsed.toJSON());
            }
        }
        return jsons;
    }
    mergeDeep(first, second) {
        return (0, lodash_mergewith_1.default)({}, first, second, (x, y) => (y === null ? x : undefined));
    }
    removeEmptyKeys(obj) {
        if (!obj) {
            return {};
        }
        Object.keys(obj).forEach((key) => {
            if (obj[key] === undefined) {
                delete obj[key];
            }
        });
        return obj;
    }
    generateDocs() {
        const files = this.globFilesMatches(this.config.baseDir, this.config.filesPattern);
        const fileContents = this.readFiles(files);
        const comments = this.getOnlyComments(fileContents);
        const jsDocInfo = this.jsdocInfo(comments);
        const yamlComments = this.parseYamlComments(jsDocInfo);
        const jsonComments = this.parseJsonCommentsFromYaml(yamlComments);
        const openApi = this.removeEmptyKeys({
            openapi: '3.0.0',
            info: this.config.info,
            servers: this.config.servers,
            paths: this.config.paths || {},
            components: Object.assign(Object.assign({}, this.config.components), { schemas: this.config.components.schemas || {} }),
            security: this.config.security,
            tags: this.config.tags,
            externalDocs: this.config.externalDocs,
        });
        for (const jsonComment of jsonComments) {
            for (const key of Object.keys(jsonComment)) {
                if (key.startsWith('/')) {
                    openApi.paths[key] = this.mergeDeep(openApi.paths[key], jsonComment[key]);
                }
                else {
                    openApi.components.schemas[key] = jsonComment[key];
                }
            }
        }
        return openApi;
    }
}
exports.default = OpenApi;
OpenApi.DEFAULT_EXCLUDED_FOLDER = 'node_modules';
OpenApi.DEFAULT_GLOB_OPTIONS = { ignore: '**/node_modules/**' };
// eslint-disable-next-line prefer-named-capture-group
OpenApi.COMMENTS_PATTERN = /((\/\*\*+[\s\S]*?\*\/)|(\/\*+.*\*\/)|^\/\/.*?[\r\n])[\r\n]*/gm;
OpenApi.BREAK_LINE = /\n/g;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3NyYy9taWNyb2svZG9jcy9vcGVuYXBpL2luZGV4LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsd0RBQWdDO0FBQ2hDLDRDQUFvQjtBQUNwQixnREFBd0I7QUFDeEIsd0VBQXlDO0FBV3pDLGdEQUF3QjtBQUN4QixnREFBd0I7QUFleEIsTUFBcUIsT0FBTztJQU94QixZQUNxQixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBSWxDLHFCQUFnQixHQUFHLENBQ3ZCLE9BQWUsRUFDZixZQUFvQixFQUNwQixpQkFBeUIsT0FBTyxDQUFDLHVCQUF1QixFQUMxRCxFQUFFO1lBQ0EsSUFBSTtnQkFDQSxNQUFNLEtBQUssR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxFQUFFLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUMzRixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO2FBQ2pFO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2FBQ3ZDO1FBQ0wsQ0FBQyxDQUFBO1FBY08sZ0JBQVcsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQzNCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDdEQsSUFBSSxRQUFRLEVBQUU7Z0JBQ1YsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDdkYsT0FBTyxj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VUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3REO2FBQ0o7U0FDSjtRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ25CLENBQUM7O0FBakpMLDBCQWtKQztBQWpKa0IsK0JBQXVCLEdBQUcsY0FBYyxDQUFDO0FBQ3pDLDRCQUFvQixHQUFHLEVBQUUsTUFBTSxFQUFFLG9CQUFvQixFQUFFLENBQUM7QUFDdkUsc0RBQXNEO0FBQ3ZDLHdCQUFnQixHQUFHLCtEQUErRCxDQUFDO0FBQ25GLGtCQUFVLEdBQUcsS0FBSyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jdWF0cm9vY2hlbnRhL01hZ2ljU2hvcHBlci9tYWdpY3Nob3BwZXItbm9kZS9zcmMvbWljcm9rL2RvY3Mvb3BlbmFwaS9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZG9jdHJpbmUgZnJvbSAnZG9jdHJpbmUnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBnbG9iIGZyb20gJ2dsb2InO1xuaW1wb3J0IG1lcmdlV2l0aCBmcm9tICdsb2Rhc2gubWVyZ2V3aXRoJztcbmltcG9ydCB7IE9wZW5BUElPYmplY3QgfSBmcm9tICdvcGVuYXBpMy10cyc7XG5pbXBvcnQge1xuICAgIENvbXBvbmVudHNPYmplY3QsXG4gICAgRXh0ZXJuYWxEb2N1bWVudGF0aW9uT2JqZWN0LFxuICAgIEluZm9PYmplY3QsXG4gICAgUGF0aHNPYmplY3QsXG4gICAgU2VjdXJpdHlSZXF1aXJlbWVudE9iamVjdCxcbiAgICBTZXJ2ZXJPYmplY3QsXG4gICAgVGFnT2JqZWN0LFxufSBmcm9tICdvcGVuYXBpMy10cy9zcmMvbW9kZWwvT3BlbkFwaSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBZQU1MIGZyb20gJ3lhbWwnO1xuXG5leHBvcnQgdHlwZSBPcGVuQXBpQ29uZmlnID0ge1xuICAgIGJhc2VEaXI6IHN0cmluZyxcbiAgICBmaWxlc1BhdHRlcm46IHN0cmluZyxcblxuICAgIGluZm86IEluZm9PYmplY3Q7XG4gICAgc2VydmVycz86IFNlcnZlck9iamVjdFtdO1xuICAgIHBhdGhzPzogUGF0aHNPYmplY3Q7XG4gICAgY29tcG9uZW50cz86IENvbXBvbmVudHNPYmplY3Q7XG4gICAgc2VjdXJpdHk/OiBTZWN1cml0eVJlcXVpcmVtZW50T2JqZWN0W107XG4gICAgdGFncz86IFRhZ09iamVjdFtdO1xuICAgIGV4dGVybmFsRG9jcz86IEV4dGVybmFsRG9jdW1lbnRhdGlvbk9iamVjdDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgT3BlbkFwaSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgREVGQVVMVF9FWENMVURFRF9GT0xERVIgPSAnbm9kZV9tb2R1bGVzJztcbiAgICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX0dMT0JfT1BUSU9OUyA9IHsgaWdub3JlOiAnKiovbm9kZV9tb2R1bGVzLyoqJyB9O1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBwcmVmZXItbmFtZWQtY2FwdHVyZS1ncm91cFxuICAgIHByaXZhdGUgc3RhdGljIENPTU1FTlRTX1BBVFRFUk4gPSAvKChcXC9cXCpcXCorW1xcc1xcU10qP1xcKlxcLyl8KFxcL1xcKisuKlxcKlxcLyl8XlxcL1xcLy4qP1tcXHJcXG5dKVtcXHJcXG5dKi9nbTtcbiAgICBwcml2YXRlIHN0YXRpYyBCUkVBS19MSU5FID0gL1xcbi9nO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBPcGVuQXBpQ29uZmlnLFxuICAgICkge1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2xvYkZpbGVzTWF0Y2hlcyA9IChcbiAgICAgICAgYmFzZURpcjogc3RyaW5nLFxuICAgICAgICBmaWxlc1BhdHRlcm46IHN0cmluZyxcbiAgICAgICAgZXhjbHVkZWRGb2xkZXI6IHN0cmluZyA9IE9wZW5BcGkuREVGQVVMVF9FWENMVURFRF9GT0xERVIsXG4gICAgKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLnJlc29sdmUoYmFzZURpciwgZmlsZXNQYXR0ZXJuKSwgT3BlbkFwaS5ERUZBVUxUX0dMT0JfT1BUSU9OUyk7XG4gICAgICAgICAgICByZXR1cm4gZmlsZXMuZmlsdGVyKChmaWxlKSA9PiAhZmlsZS5pbmNsdWRlcyhleGNsdWRlZEZvbGRlcikpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBHbG9iIEZpbGVzJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlYWRGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoKS50b1N0cmluZygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVhZEZpbGVzKGZpbGVzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcbiAgICAgICAgaWYgKCFmaWxlcyB8fCAhQXJyYXkuaXNBcnJheShmaWxlcykpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmlsZXMubWFwKChmaWxlKSA9PiB0aGlzLnJlYWRGaWxlKGZpbGUpKTtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgZ2V0Q29tbWVudHMgPSAodGV4dCkgPT4ge1xuICAgICAgICBjb25zdCBjb21tZW50cyA9IHRleHQubWF0Y2goT3BlbkFwaS5DT01NRU5UU19QQVRURVJOKTtcbiAgICAgICAgaWYgKGNvbW1lbnRzKSB7XG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJDb21tZW50cyA9IGNvbW1lbnRzLmZpbHRlcigoY29tbWVudCkgPT4gY29tbWVudC5tYXRjaChPcGVuQXBpLkJSRUFLX0xJTkUpKTtcbiAgICAgICAgICAgIHJldHVybiBmaWx0ZXJDb21tZW50cy5tYXAoKGNvbW1lbnQpID0+IGNvbW1lbnQudHJpbSgpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW107XG4gICAgfTtcblxuICAgIHByaXZhdGUgZ2V0T25seUNvbW1lbnRzKGZpbGVDb250ZW50czogc3RyaW5nW10gPSBbXSkge1xuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmlsZUNvbnRlbnRzKSkge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvbW1lbnRzID0gZmlsZUNvbnRlbnRzLm1hcCgoY29tbWVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdHJpbWVkQ29tbWVudHMgPSBjb21tZW50LnRyaW0oKTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENvbW1lbnRzKHRyaW1lZENvbW1lbnRzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBbXS5jb25jYXQoLi4uY29tbWVudHMpLmZpbHRlcigoY29tbWVudCkgPT4gKGNvbW1lbnRbMF0gPT09ICcvJyAmJiBjb21tZW50WzFdICE9PSAnLycpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGpzZG9jSW5mbyhjb21tZW50cyk6IGFueVtdIHtcbiAgICAgICAgaWYgKCFjb21tZW50cyB8fCAhQXJyYXkuaXNBcnJheShjb21tZW50cykpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY29tbWVudHMubWFwKChjb21tZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBqc0RvY0NvbW1lbnQgPSBkb2N0cmluZS5wYXJzZShjb21tZW50LCB7IHVud3JhcDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIHJldHVybiBqc0RvY0NvbW1lbnQ7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VZYW1sQ29tbWVudHMoanNEb2M6IGFueVtdKSB7XG4gICAgICAgIGNvbnN0IHlhbWxDb21tZW50cyA9IFtdXG4gICAgICAgIGZvciAoY29uc3QgZG9jIG9mIGpzRG9jKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRhZyBvZiBkb2MudGFncykge1xuICAgICAgICAgICAgICAgIGlmICh0YWcudGl0bGUgPT09ICdvcGVuYXBpJykge1xuICAgICAgICAgICAgICAgICAgICB5YW1sQ29tbWVudHMucHVzaCh0YWcuZGVzY3JpcHRpb24pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB5YW1sQ29tbWVudHM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZUpzb25Db21tZW50c0Zyb21ZYW1sKHlhbWxDb21tZW50cyk6IG9iamVjdFtdIHtcbiAgICAgICAgY29uc3QganNvbnMgPSBbXVxuICAgICAgICBmb3IgKGNvbnN0IGRvYyBvZiB5YW1sQ29tbWVudHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZCA9IFlBTUwucGFyc2VEb2N1bWVudChkb2MpO1xuXG4gICAgICAgICAgICBjb25zdCBhbmNob3JzID0gcGFyc2VkLmFuY2hvcnMuZ2V0TmFtZXMoKTtcbiAgICAgICAgICAgIGlmIChhbmNob3JzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgcGFyc2luZyBZQU1MIGNvbW1lbnRzJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHBhcnNlZC5lcnJvcnMgJiYgcGFyc2VkLmVycm9ycy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIHBhcnNpbmcgWUFNTCBjb21tZW50cycpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBqc29ucy5wdXNoKHBhcnNlZC50b0pTT04oKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGpzb25zO1xuICAgIH1cblxuICAgIHByaXZhdGUgbWVyZ2VEZWVwKGZpcnN0LCBzZWNvbmQpIHtcbiAgICAgICAgcmV0dXJuIG1lcmdlV2l0aCh7fSwgZmlyc3QsIHNlY29uZCwgKHgsIHkpID0+ICh5ID09PSBudWxsID8geCA6IHVuZGVmaW5lZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlRW1wdHlLZXlzKG9iaikge1xuICAgICAgICBpZiAoIW9iaikge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAob2JqW2tleV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBvYmpba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVEb2NzKCk6IE9wZW5BUElPYmplY3Qge1xuICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMuZ2xvYkZpbGVzTWF0Y2hlcyh0aGlzLmNvbmZpZy5iYXNlRGlyLCB0aGlzLmNvbmZpZy5maWxlc1BhdHRlcm4pO1xuICAgICAgICBjb25zdCBmaWxlQ29udGVudHMgPSB0aGlzLnJlYWRGaWxlcyhmaWxlcyk7XG4gICAgICAgIGNvbnN0IGNvbW1lbnRzID0gdGhpcy5nZXRPbmx5Q29tbWVudHMoZmlsZUNvbnRlbnRzKTtcbiAgICAgICAgY29uc3QganNEb2NJbmZvID0gdGhpcy5qc2RvY0luZm8oY29tbWVudHMpXG4gICAgICAgIGNvbnN0IHlhbWxDb21tZW50cyA9IHRoaXMucGFyc2VZYW1sQ29tbWVudHMoanNEb2NJbmZvKVxuICAgICAgICBjb25zdCBqc29uQ29tbWVudHMgPSB0aGlzLnBhcnNlSnNvbkNvbW1lbnRzRnJvbVlhbWwoeWFtbENvbW1lbnRzKVxuXG4gICAgICAgIGNvbnN0IG9wZW5BcGk6IE9wZW5BUElPYmplY3QgPSB0aGlzLnJlbW92ZUVtcHR5S2V5cyh7XG4gICAgICAgICAgICBvcGVuYXBpOiAnMy4wLjAnLFxuICAgICAgICAgICAgaW5mbzogdGhpcy5jb25maWcuaW5mbyxcbiAgICAgICAgICAgIHNlcnZlcnM6IHRoaXMuY29uZmlnLnNlcnZlcnMsXG4gICAgICAgICAgICBwYXRoczogdGhpcy5jb25maWcucGF0aHMgfHwge30sXG4gICAgICAgICAgICBjb21wb25lbnRzOiB7XG4gICAgICAgICAgICAgICAgLi4udGhpcy5jb25maWcuY29tcG9uZW50cyxcbiAgICAgICAgICAgICAgICBzY2hlbWFzOiB0aGlzLmNvbmZpZy5jb21wb25lbnRzLnNjaGVtYXMgfHwge30sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2VjdXJpdHk6IHRoaXMuY29uZmlnLnNlY3VyaXR5LFxuICAgICAgICAgICAgdGFnczogdGhpcy5jb25maWcudGFncyxcbiAgICAgICAgICAgIGV4dGVybmFsRG9jczogdGhpcy5jb25maWcuZXh0ZXJuYWxEb2NzLFxuICAgICAgICB9KTtcblxuICAgICAgICBmb3IgKGNvbnN0IGpzb25Db21tZW50IG9mIGpzb25Db21tZW50cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoanNvbkNvbW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKCcvJykpIHtcbiAgICAgICAgICAgICAgICAgICAgb3BlbkFwaS5wYXRoc1trZXldID0gdGhpcy5tZXJnZURlZXAob3BlbkFwaS5wYXRoc1trZXldLCBqc29uQ29tbWVudFtrZXldKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvcGVuQXBpLmNvbXBvbmVudHMuc2NoZW1hc1trZXldID0ganNvbkNvbW1lbnRba2V5XTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gb3BlbkFwaTtcbiAgICB9XG59XG4iXSwidmVyc2lvbiI6M30=