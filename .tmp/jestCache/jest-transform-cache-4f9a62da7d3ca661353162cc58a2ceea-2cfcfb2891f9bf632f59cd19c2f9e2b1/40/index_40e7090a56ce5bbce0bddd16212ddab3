0868c51faeb28c3f4c5f24a8587e684c
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const glob_1 = __importDefault(require("glob"));
const lodash_mergewith_1 = __importDefault(require("lodash.mergewith"));
const path_1 = __importDefault(require("path"));
const jsDocInfo_1 = require("./consumers/jsDocInfo");
const parseJsonCommentsFromYaml_1 = require("./consumers/parseJsonCommentsFromYaml");
const parseYamlComments_1 = require("./consumers/parseYamlComments");
class OpenApi {
    constructor(config) {
        this.config = config;
        this.globFilesMatches = (baseDir, filesPattern, excludedFolder = OpenApi.DEFAULT_EXCLUDED_FOLDER) => {
            try {
                const files = glob_1.default.sync(path_1.default.resolve(baseDir, filesPattern), OpenApi.DEFAULT_GLOB_OPTIONS);
                return files.filter((file) => !file.includes(excludedFolder));
            }
            catch (error) {
                throw new Error('Error Glob Files');
            }
        };
        this.getComments = (text) => {
            const comments = text.match(OpenApi.COMMENTS_PATTERN);
            if (comments) {
                const filterComments = comments.filter((comment) => comment.match(OpenApi.BREAK_LINE));
                return filterComments.map((comment) => comment.trim());
            }
            return [];
        };
        this.getOnlyComments = (fileContents = []) => {
            if (!Array.isArray(fileContents)) {
                return [];
            }
            const comments = fileContents.map((comment) => {
                const trimedComments = comment.trim();
                return this.getComments(trimedComments);
            });
            return [].concat(...comments).filter((comment) => (comment[0] === '/' && comment[1] !== '/'));
        };
    }
    readFile(filePath) {
        return fs_1.default.readFileSync(filePath).toString();
    }
    readFiles(files) {
        if (!files || !Array.isArray(files)) {
            return [];
        }
        return files.map((file) => this.readFile(file));
    }
    mergeDeep(first, second) {
        return (0, lodash_mergewith_1.default)({}, first, second, (x, y) => (y === null ? x : undefined));
    }
    removeEmptyKeys(obj) {
        if (!obj) {
            return {};
        }
        Object.keys(obj).forEach((key) => {
            if (obj[key] === undefined) {
                delete obj[key];
            }
        });
        return obj;
    }
    generateDocs() {
        const files = this.globFilesMatches(this.config.baseDir, this.config.filesPattern);
        const fileContents = this.readFiles(files);
        const comments = this.getOnlyComments(fileContents);
        const jsDocInfo = (0, jsDocInfo_1.jsdocInfo)()(comments);
        const yamlComments = (0, parseYamlComments_1.parseYamlComments)(jsDocInfo);
        const jsonComments = (0, parseJsonCommentsFromYaml_1.parseJsonCommentsFromYaml)(yamlComments);
        const openApi = this.removeEmptyKeys({
            openapi: '3.0.0',
            info: this.config.info,
            servers: this.config.servers,
            paths: this.config.paths || {},
            components: Object.assign(Object.assign({}, this.config.components), { schemas: this.config.components.schemas || {} }),
            security: this.config.security,
            tags: this.config.tags,
            externalDocs: this.config.externalDocs,
        });
        for (const jsonComment of jsonComments) {
            for (const key of Object.keys(jsonComment)) {
                if (key.startsWith('/')) {
                    openApi.paths[key] = this.mergeDeep(openApi.paths[key], jsonComment[key]);
                }
                else {
                    openApi.components.schemas[key] = jsonComment[key];
                }
            }
        }
        return openApi;
    }
}
exports.default = OpenApi;
OpenApi.DEFAULT_EXCLUDED_FOLDER = 'node_modules';
OpenApi.DEFAULT_GLOB_OPTIONS = { ignore: '**/node_modules/**' };
// eslint-disable-next-line prefer-named-capture-group
OpenApi.COMMENTS_PATTERN = /((\/\*\*+[\s\S]*?\*\/)|(\/\*+.*\*\/)|^\/\/.*?[\r\n])[\r\n]*/gm;
OpenApi.BREAK_LINE = /\n/g;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3NyYy9taWNyb2svZG9jcy9vcGVuYXBpL2luZGV4LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4Qix3RUFBeUM7QUFXekMsZ0RBQXdCO0FBQ3hCLHFEQUFrRDtBQUNsRCxxRkFBa0Y7QUFDbEYscUVBQWtFO0FBZWxFLE1BQXFCLE9BQU87SUFPeEIsWUFDcUIsTUFBcUI7UUFBckIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUlsQyxxQkFBZ0IsR0FBRyxDQUN2QixPQUFlLEVBQ2YsWUFBb0IsRUFDcEIsaUJBQXlCLE9BQU8sQ0FBQyx1QkFBdUIsRUFDMUQsRUFBRTtZQUNBLElBQUk7Z0JBQ0EsTUFBTSxLQUFLLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsRUFBRSxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztnQkFDM0YsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQzthQUNqRTtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUN2QztRQUNMLENBQUMsQ0FBQTtRQWNPLGdCQUFXLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUMzQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3RELElBQUksUUFBUSxFQUFFO2dCQUNWLE1BQU0sY0FBYyxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7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Q0FBQztBQUN6Qyw0QkFBb0IsR0FBRyxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxDQUFDO0FBQ3ZFLHNEQUFzRDtBQUN2Qyx3QkFBZ0IsR0FBRywrREFBK0QsQ0FBQztBQUNuRixrQkFBVSxHQUFHLEtBQUssQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY3VhdHJvb2NoZW50YS9NYWdpY1Nob3BwZXIvbWFnaWNzaG9wcGVyLW5vZGUvc3JjL21pY3Jvay9kb2NzL29wZW5hcGkvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBnbG9iIGZyb20gJ2dsb2InO1xuaW1wb3J0IG1lcmdlV2l0aCBmcm9tICdsb2Rhc2gubWVyZ2V3aXRoJztcbmltcG9ydCB7IE9wZW5BUElPYmplY3QgfSBmcm9tICdvcGVuYXBpMy10cyc7XG5pbXBvcnQge1xuICAgIENvbXBvbmVudHNPYmplY3QsXG4gICAgRXh0ZXJuYWxEb2N1bWVudGF0aW9uT2JqZWN0LFxuICAgIEluZm9PYmplY3QsXG4gICAgUGF0aHNPYmplY3QsXG4gICAgU2VjdXJpdHlSZXF1aXJlbWVudE9iamVjdCxcbiAgICBTZXJ2ZXJPYmplY3QsXG4gICAgVGFnT2JqZWN0LFxufSBmcm9tICdvcGVuYXBpMy10cy9zcmMvbW9kZWwvT3BlbkFwaSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGpzZG9jSW5mbyB9IGZyb20gJy4vY29uc3VtZXJzL2pzRG9jSW5mbyc7XG5pbXBvcnQgeyBwYXJzZUpzb25Db21tZW50c0Zyb21ZYW1sIH0gZnJvbSAnLi9jb25zdW1lcnMvcGFyc2VKc29uQ29tbWVudHNGcm9tWWFtbCc7XG5pbXBvcnQgeyBwYXJzZVlhbWxDb21tZW50cyB9IGZyb20gJy4vY29uc3VtZXJzL3BhcnNlWWFtbENvbW1lbnRzJztcblxuZXhwb3J0IHR5cGUgT3BlbkFwaUNvbmZpZyA9IHtcbiAgICBiYXNlRGlyOiBzdHJpbmcsXG4gICAgZmlsZXNQYXR0ZXJuOiBzdHJpbmcsXG5cbiAgICBpbmZvOiBJbmZvT2JqZWN0O1xuICAgIHNlcnZlcnM/OiBTZXJ2ZXJPYmplY3RbXTtcbiAgICBwYXRocz86IFBhdGhzT2JqZWN0O1xuICAgIGNvbXBvbmVudHM/OiBDb21wb25lbnRzT2JqZWN0O1xuICAgIHNlY3VyaXR5PzogU2VjdXJpdHlSZXF1aXJlbWVudE9iamVjdFtdO1xuICAgIHRhZ3M/OiBUYWdPYmplY3RbXTtcbiAgICBleHRlcm5hbERvY3M/OiBFeHRlcm5hbERvY3VtZW50YXRpb25PYmplY3Q7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9wZW5BcGkge1xuICAgIHByaXZhdGUgc3RhdGljIERFRkFVTFRfRVhDTFVERURfRk9MREVSID0gJ25vZGVfbW9kdWxlcyc7XG4gICAgcHJpdmF0ZSBzdGF0aWMgREVGQVVMVF9HTE9CX09QVElPTlMgPSB7IGlnbm9yZTogJyoqL25vZGVfbW9kdWxlcy8qKicgfTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLW5hbWVkLWNhcHR1cmUtZ3JvdXBcbiAgICBwcml2YXRlIHN0YXRpYyBDT01NRU5UU19QQVRURVJOID0gLygoXFwvXFwqXFwqK1tcXHNcXFNdKj9cXCpcXC8pfChcXC9cXCorLipcXCpcXC8pfF5cXC9cXC8uKj9bXFxyXFxuXSlbXFxyXFxuXSovZ207XG4gICAgcHJpdmF0ZSBzdGF0aWMgQlJFQUtfTElORSA9IC9cXG4vZztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogT3BlbkFwaUNvbmZpZyxcbiAgICApIHtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdsb2JGaWxlc01hdGNoZXMgPSAoXG4gICAgICAgIGJhc2VEaXI6IHN0cmluZyxcbiAgICAgICAgZmlsZXNQYXR0ZXJuOiBzdHJpbmcsXG4gICAgICAgIGV4Y2x1ZGVkRm9sZGVyOiBzdHJpbmcgPSBPcGVuQXBpLkRFRkFVTFRfRVhDTFVERURfRk9MREVSLFxuICAgICkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5yZXNvbHZlKGJhc2VEaXIsIGZpbGVzUGF0dGVybiksIE9wZW5BcGkuREVGQVVMVF9HTE9CX09QVElPTlMpO1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVzLmZpbHRlcigoZmlsZSkgPT4gIWZpbGUuaW5jbHVkZXMoZXhjbHVkZWRGb2xkZXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgR2xvYiBGaWxlcycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWFkRmlsZShmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlYWRGaWxlcyhmaWxlczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgICAgIGlmICghZmlsZXMgfHwgIUFycmF5LmlzQXJyYXkoZmlsZXMpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVzLm1hcCgoZmlsZSkgPT4gdGhpcy5yZWFkRmlsZShmaWxlKSk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGdldENvbW1lbnRzID0gKHRleHQpID0+IHtcbiAgICAgICAgY29uc3QgY29tbWVudHMgPSB0ZXh0Lm1hdGNoKE9wZW5BcGkuQ09NTUVOVFNfUEFUVEVSTik7XG4gICAgICAgIGlmIChjb21tZW50cykge1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyQ29tbWVudHMgPSBjb21tZW50cy5maWx0ZXIoKGNvbW1lbnQpID0+IGNvbW1lbnQubWF0Y2goT3BlbkFwaS5CUkVBS19MSU5FKSk7XG4gICAgICAgICAgICByZXR1cm4gZmlsdGVyQ29tbWVudHMubWFwKChjb21tZW50KSA9PiBjb21tZW50LnRyaW0oKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdldE9ubHlDb21tZW50cyA9IChmaWxlQ29udGVudHM6IHN0cmluZ1tdID0gW10pID0+IHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGZpbGVDb250ZW50cykpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21tZW50cyA9IGZpbGVDb250ZW50cy5tYXAoKGNvbW1lbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRyaW1lZENvbW1lbnRzID0gY29tbWVudC50cmltKCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb21tZW50cyh0cmltZWRDb21tZW50cyk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gW10uY29uY2F0KC4uLmNvbW1lbnRzKS5maWx0ZXIoKGNvbW1lbnQpID0+IChjb21tZW50WzBdID09PSAnLycgJiYgY29tbWVudFsxXSAhPT0gJy8nKSk7XG4gICAgfTtcblxuICAgIHByaXZhdGUgbWVyZ2VEZWVwKGZpcnN0LCBzZWNvbmQpIHtcbiAgICAgICAgcmV0dXJuIG1lcmdlV2l0aCh7fSwgZmlyc3QsIHNlY29uZCwgKHgsIHkpID0+ICh5ID09PSBudWxsID8geCA6IHVuZGVmaW5lZCkpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVtb3ZlRW1wdHlLZXlzKG9iaikge1xuICAgICAgICBpZiAoIW9iaikge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG4gICAgICAgIE9iamVjdC5rZXlzKG9iaikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICBpZiAob2JqW2tleV0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBvYmpba2V5XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuXG4gICAgZ2VuZXJhdGVEb2NzKCk6IE9wZW5BUElPYmplY3Qge1xuICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMuZ2xvYkZpbGVzTWF0Y2hlcyh0aGlzLmNvbmZpZy5iYXNlRGlyLCB0aGlzLmNvbmZpZy5maWxlc1BhdHRlcm4pO1xuICAgICAgICBjb25zdCBmaWxlQ29udGVudHMgPSB0aGlzLnJlYWRGaWxlcyhmaWxlcyk7XG4gICAgICAgIGNvbnN0IGNvbW1lbnRzID0gdGhpcy5nZXRPbmx5Q29tbWVudHMoZmlsZUNvbnRlbnRzKTtcbiAgICAgICAgY29uc3QganNEb2NJbmZvID0ganNkb2NJbmZvKCkoY29tbWVudHMpXG4gICAgICAgIGNvbnN0IHlhbWxDb21tZW50cyA9IHBhcnNlWWFtbENvbW1lbnRzKGpzRG9jSW5mbylcbiAgICAgICAgY29uc3QganNvbkNvbW1lbnRzID0gcGFyc2VKc29uQ29tbWVudHNGcm9tWWFtbCh5YW1sQ29tbWVudHMpXG5cbiAgICAgICAgY29uc3Qgb3BlbkFwaTogT3BlbkFQSU9iamVjdCA9IHRoaXMucmVtb3ZlRW1wdHlLZXlzKHtcbiAgICAgICAgICAgIG9wZW5hcGk6ICczLjAuMCcsXG4gICAgICAgICAgICBpbmZvOiB0aGlzLmNvbmZpZy5pbmZvLFxuICAgICAgICAgICAgc2VydmVyczogdGhpcy5jb25maWcuc2VydmVycyxcbiAgICAgICAgICAgIHBhdGhzOiB0aGlzLmNvbmZpZy5wYXRocyB8fCB7fSxcbiAgICAgICAgICAgIGNvbXBvbmVudHM6IHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLmNvbmZpZy5jb21wb25lbnRzLFxuICAgICAgICAgICAgICAgIHNjaGVtYXM6IHRoaXMuY29uZmlnLmNvbXBvbmVudHMuc2NoZW1hcyB8fCB7fSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZWN1cml0eTogdGhpcy5jb25maWcuc2VjdXJpdHksXG4gICAgICAgICAgICB0YWdzOiB0aGlzLmNvbmZpZy50YWdzLFxuICAgICAgICAgICAgZXh0ZXJuYWxEb2NzOiB0aGlzLmNvbmZpZy5leHRlcm5hbERvY3MsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QganNvbkNvbW1lbnQgb2YganNvbkNvbW1lbnRzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhqc29uQ29tbWVudCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgICAgICAgICAgICAgICAgICBvcGVuQXBpLnBhdGhzW2tleV0gPSB0aGlzLm1lcmdlRGVlcChvcGVuQXBpLnBhdGhzW2tleV0sIGpzb25Db21tZW50W2tleV0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wZW5BcGkuY29tcG9uZW50cy5zY2hlbWFzW2tleV0gPSBqc29uQ29tbWVudFtrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcGVuQXBpO1xuICAgIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==