38fd59ed55e838c4cddd192571f20657
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const NotFoundHttpError_1 = __importDefault(require("@microk/common/http/errors/NotFoundHttpError"));
const UnauthorizedHttpError_1 = __importDefault(require("@microk/common/http/errors/UnauthorizedHttpError"));
const AuthenticateQueryHandler_1 = __importDefault(require("../../../../src/modules/auth/application/login/AuthenticateQueryHandler"));
const Authenticator_1 = __importDefault(require("../../../../src/modules/auth/application/login/Authenticator"));
const AuthTokenRepositoryMock_1 = __importDefault(require("../__mocks__/AuthTokenRepositoryMock"));
const AuthUserRepositoryMock_1 = __importDefault(require("../__mocks__/AuthUserRepositoryMock"));
const AuthUserMother_1 = __importDefault(require("../domain/AuthUserMother"));
const AuthenticateQueryMother_1 = __importDefault(require("./AuthenticateQueryMother"));
let authUserRepository;
let authTokenRepository;
let authenticateQueryHandler;
beforeEach(() => {
    authTokenRepository = new AuthTokenRepositoryMock_1.default();
    authUserRepository = new AuthUserRepositoryMock_1.default();
    authenticateQueryHandler = new AuthenticateQueryHandler_1.default(new Authenticator_1.default(authUserRepository, authTokenRepository));
});
describe('Authenticator', () => {
    it('should create a valid auth token', () => __awaiter(void 0, void 0, void 0, function* () {
        const query = AuthenticateQueryMother_1.default.random();
        const authUser = AuthUserMother_1.default.fromQuery(query);
        authUserRepository.mockReturn(authUser);
        const authToken = yield authenticateQueryHandler.handle(query);
        expect(authToken.toString()).toBeDefined();
    }));
    it('should throw NotFoundError if user not exists', () => __awaiter(void 0, void 0, void 0, function* () {
        const query = AuthenticateQueryMother_1.default.random();
        authUserRepository.mockReturn(null);
        yield expect(() => __awaiter(void 0, void 0, void 0, function* () {
            yield authenticateQueryHandler.handle(query);
        })).rejects.toThrow(NotFoundHttpError_1.default);
    }));
    it('should throw UnauthorizedHttpError if user credentials are invalid', () => __awaiter(void 0, void 0, void 0, function* () {
        const query = AuthenticateQueryMother_1.default.random();
        const authUser = AuthUserMother_1.default.random();
        authUserRepository.mockReturn(authUser);
        yield expect(() => __awaiter(void 0, void 0, void 0, function* () {
            yield authenticateQueryHandler.handle(query);
        })).rejects.toThrow(UnauthorizedHttpError_1.default);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3Rlc3RzL21vZHVsZXMvYXV0aC9hcHBsaWNhdGlvbi9BdXRoZW50aWNhdG9yLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxR0FBNkU7QUFDN0UsNkdBQXFGO0FBQ3JGLHVJQUErRztBQUMvRyxpSEFBeUY7QUFFekYsbUdBQTJFO0FBQzNFLGlHQUF5RTtBQUN6RSw4RUFBc0Q7QUFDdEQsd0ZBQWdFO0FBRWhFLElBQUksa0JBQTBDLENBQUM7QUFDL0MsSUFBSSxtQkFBd0MsQ0FBQztBQUM3QyxJQUFJLHdCQUFrRCxDQUFDO0FBRXZELFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDWixtQkFBbUIsR0FBRyxJQUFJLGlDQUF1QixFQUFFLENBQUM7SUFDcEQsa0JBQWtCLEdBQUcsSUFBSSxnQ0FBc0IsRUFBRSxDQUFDO0lBQ2xELHdCQUF3QixHQUFHLElBQUksa0NBQXdCLENBQUMsSUFBSSx1QkFBYSxDQUFDLGtCQUFrQixFQUFFLG1CQUFtQixDQUFDLENBQUMsQ0FBQTtBQUN2SCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO0lBQzNCLEVBQUUsQ0FBQyxrQ0FBa0MsRUFBRSxHQUFTLEVBQUU7UUFDOUMsTUFBTSxLQUFLLEdBQUcsaUNBQXVCLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDL0MsTUFBTSxRQUFRLEdBQUcsd0JBQWMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDakQsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sU0FBUyxHQUFHLE1BQU0sd0JBQXdCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRS9ELE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMvQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLCtDQUErQyxFQUFFLEdBQVMsRUFBRTtRQUMzRCxNQUFNLEtBQUssR0FBRyxpQ0FBdUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUMvQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFcEMsTUFBTSxNQUFNLENBQUMsR0FBUyxFQUFFO1lBQ3BCLE1BQU0sd0JBQXdCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pELENBQUMsQ0FBQSxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywyQkFBaUIsQ0FBQyxDQUFDO0lBQzFDLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFFSCxFQUFFLENBQUMsb0VBQW9FLEVBQUUsR0FBUyxFQUFFO1FBQ2hGLE1BQU0sS0FBSyxHQUFHLGlDQUF1QixDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQy9DLE1BQU0sUUFBUSxHQUFHLHdCQUFjLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDekMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXhDLE1BQU0sTUFBTSxDQUFDLEdBQVMsRUFBRTtZQUNwQixNQUFNLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsK0JBQXFCLENBQUMsQ0FBQztJQUM5QyxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3Rlc3RzL21vZHVsZXMvYXV0aC9hcHBsaWNhdGlvbi9BdXRoZW50aWNhdG9yLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IE5vdEZvdW5kSHR0cEVycm9yIGZyb20gJ0BtaWNyb2svY29tbW9uL2h0dHAvZXJyb3JzL05vdEZvdW5kSHR0cEVycm9yJztcbmltcG9ydCBVbmF1dGhvcml6ZWRIdHRwRXJyb3IgZnJvbSAnQG1pY3Jvay9jb21tb24vaHR0cC9lcnJvcnMvVW5hdXRob3JpemVkSHR0cEVycm9yJztcbmltcG9ydCBBdXRoZW50aWNhdGVRdWVyeUhhbmRsZXIgZnJvbSAnLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvYXV0aC9hcHBsaWNhdGlvbi9sb2dpbi9BdXRoZW50aWNhdGVRdWVyeUhhbmRsZXInO1xuaW1wb3J0IEF1dGhlbnRpY2F0b3IgZnJvbSAnLi4vLi4vLi4vLi4vc3JjL21vZHVsZXMvYXV0aC9hcHBsaWNhdGlvbi9sb2dpbi9BdXRoZW50aWNhdG9yJztcbmltcG9ydCBBdXRoVG9rZW5SZXBvc2l0b3J5IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9tb2R1bGVzL2F1dGgvZG9tYWluL0F1dGhUb2tlblJlcG9zaXRvcnknO1xuaW1wb3J0IEF1dGhUb2tlblJlcG9zaXRvcnlNb2NrIGZyb20gJy4uL19fbW9ja3NfXy9BdXRoVG9rZW5SZXBvc2l0b3J5TW9jayc7XG5pbXBvcnQgQXV0aFVzZXJSZXBvc2l0b3J5TW9jayBmcm9tICcuLi9fX21vY2tzX18vQXV0aFVzZXJSZXBvc2l0b3J5TW9jayc7XG5pbXBvcnQgQXV0aFVzZXJNb3RoZXIgZnJvbSAnLi4vZG9tYWluL0F1dGhVc2VyTW90aGVyJztcbmltcG9ydCBBdXRoZW50aWNhdGVRdWVyeU1vdGhlciBmcm9tICcuL0F1dGhlbnRpY2F0ZVF1ZXJ5TW90aGVyJztcblxubGV0IGF1dGhVc2VyUmVwb3NpdG9yeTogQXV0aFVzZXJSZXBvc2l0b3J5TW9jaztcbmxldCBhdXRoVG9rZW5SZXBvc2l0b3J5OiBBdXRoVG9rZW5SZXBvc2l0b3J5O1xubGV0IGF1dGhlbnRpY2F0ZVF1ZXJ5SGFuZGxlcjogQXV0aGVudGljYXRlUXVlcnlIYW5kbGVyO1xuXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgICBhdXRoVG9rZW5SZXBvc2l0b3J5ID0gbmV3IEF1dGhUb2tlblJlcG9zaXRvcnlNb2NrKCk7XG4gICAgYXV0aFVzZXJSZXBvc2l0b3J5ID0gbmV3IEF1dGhVc2VyUmVwb3NpdG9yeU1vY2soKTtcbiAgICBhdXRoZW50aWNhdGVRdWVyeUhhbmRsZXIgPSBuZXcgQXV0aGVudGljYXRlUXVlcnlIYW5kbGVyKG5ldyBBdXRoZW50aWNhdG9yKGF1dGhVc2VyUmVwb3NpdG9yeSwgYXV0aFRva2VuUmVwb3NpdG9yeSkpXG59KTtcblxuZGVzY3JpYmUoJ0F1dGhlbnRpY2F0b3InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSB2YWxpZCBhdXRoIHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9IEF1dGhlbnRpY2F0ZVF1ZXJ5TW90aGVyLnJhbmRvbSgpO1xuICAgICAgICBjb25zdCBhdXRoVXNlciA9IEF1dGhVc2VyTW90aGVyLmZyb21RdWVyeShxdWVyeSk7XG4gICAgICAgIGF1dGhVc2VyUmVwb3NpdG9yeS5tb2NrUmV0dXJuKGF1dGhVc2VyKTtcblxuICAgICAgICBjb25zdCBhdXRoVG9rZW4gPSBhd2FpdCBhdXRoZW50aWNhdGVRdWVyeUhhbmRsZXIuaGFuZGxlKHF1ZXJ5KTtcblxuICAgICAgICBleHBlY3QoYXV0aFRva2VuLnRvU3RyaW5nKCkpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IE5vdEZvdW5kRXJyb3IgaWYgdXNlciBub3QgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9IEF1dGhlbnRpY2F0ZVF1ZXJ5TW90aGVyLnJhbmRvbSgpO1xuICAgICAgICBhdXRoVXNlclJlcG9zaXRvcnkubW9ja1JldHVybihudWxsKTtcblxuICAgICAgICBhd2FpdCBleHBlY3QoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgYXV0aGVudGljYXRlUXVlcnlIYW5kbGVyLmhhbmRsZShxdWVyeSk7XG4gICAgICAgIH0pLnJlamVjdHMudG9UaHJvdyhOb3RGb3VuZEh0dHBFcnJvcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IFVuYXV0aG9yaXplZEh0dHBFcnJvciBpZiB1c2VyIGNyZWRlbnRpYWxzIGFyZSBpbnZhbGlkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBxdWVyeSA9IEF1dGhlbnRpY2F0ZVF1ZXJ5TW90aGVyLnJhbmRvbSgpO1xuICAgICAgICBjb25zdCBhdXRoVXNlciA9IEF1dGhVc2VyTW90aGVyLnJhbmRvbSgpO1xuICAgICAgICBhdXRoVXNlclJlcG9zaXRvcnkubW9ja1JldHVybihhdXRoVXNlcik7XG5cbiAgICAgICAgYXdhaXQgZXhwZWN0KGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IGF1dGhlbnRpY2F0ZVF1ZXJ5SGFuZGxlci5oYW5kbGUocXVlcnkpO1xuICAgICAgICB9KS5yZWplY3RzLnRvVGhyb3coVW5hdXRob3JpemVkSHR0cEVycm9yKTtcbiAgICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9