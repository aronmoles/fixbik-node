27f3b47404e7f9b7d1474104a634d70d
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const amqp_ts_1 = require("amqp-ts");
const Executor_1 = __importDefault(require("../../../core/infrastructure/Executor"));
class RabbitMqEventbus {
    constructor(config, domainEventSubscriberMapper, deserializer, logger, executors = []) {
        this.domainEventSubscriberMapper = domainEventSubscriberMapper;
        this.deserializer = deserializer;
        this.logger = logger;
        this.executor = new Executor_1.default(executors);
        this.connection = new amqp_ts_1.Connection(`amqp://${config.user}:${config.password}@${config.host}`);
        this.exchange = this.connection.declareExchange(config.exchange, 'fanout', { durable: false });
        this.queue = this.connection.declareQueue(config.queue);
    }
    start() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.deserializer) {
                throw new Error('RabbitMqEventBus has not being properly initialized, deserializer is missing');
            }
            yield this.connection.completeConfiguration();
            yield this.queue.bind(this.exchange);
            yield this.queue.stopConsumer();
            yield this.queue.activateConsumer((message) => __awaiter(this, void 0, void 0, function* () {
                try {
                    const event = this.deserializer.deserialize(message.content.toString());
                    if (event) {
                        const subscribers = this.domainEventSubscriberMapper.search(event.name);
                        if (subscribers) {
                            const subscribersNames = subscribers.map((subscriber) => subscriber.constructor.name);
                            this.logger.info(`[RabbitMqEventBus] Message processed: ${event.name.toString()} by ${subscribersNames.join(', ')}`);
                            const subscribersExecutions = subscribers.map((subscriber) => {
                                return this.executor.run(event, () => __awaiter(this, void 0, void 0, function* () { return subscriber.dispatch(event); }));
                            });
                            yield Promise.all(subscribersExecutions);
                        }
                    }
                    message.ack();
                }
                catch (error) {
                    message.reject();
                }
            }), { noAck: false });
        });
    }
    publish(events) {
        return __awaiter(this, void 0, void 0, function* () {
            events.forEach((event) => {
                const eventPrimitive = event.toPrimitive();
                const message = new amqp_ts_1.Message({
                    data: Object.assign(Object.assign({}, eventPrimitive), { meta: undefined }),
                    meta: eventPrimitive.meta,
                });
                this.logger.info(`[RabbitMqEventBus] Event to be published: ${event.name.toString()}`);
                this.exchange.send(message);
            });
        });
    }
}
exports.default = RabbitMqEventbus;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3NyYy9taWNyb2svZXZlbnQvaW5mcmFzdHJ1Y3R1cmUvcmFiYml0LW1xL1JhYmJpdE1xRXZlbnRCdXMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSxxQ0FBK0Q7QUFJL0QscUZBQTZEO0FBUTdELE1BQXFCLGdCQUFnQjtJQU9qQyxZQUNJLE1BQXNCLEVBQ0wsMkJBQXFGLEVBQ3JGLFlBQW1DLEVBQ25DLE1BQWMsRUFDL0IsWUFBa0QsRUFBRTtRQUhuQyxnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTBEO1FBQ3JGLGlCQUFZLEdBQVosWUFBWSxDQUF1QjtRQUNuQyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBRy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxrQkFBUSxDQUFvQixTQUFTLENBQUMsQ0FBQztRQUUzRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksb0JBQVUsQ0FBQyxVQUFVLE1BQU0sQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLFFBQVEsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM1RixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDL0YsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVLLEtBQUs7O1lBQ1AsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7Z0JBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsOEVBQThFLENBQUMsQ0FBQzthQUNuRztZQUVELE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1lBRTlDLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNoQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQzdCLENBQU0sT0FBTyxFQUFFLEVBQUU7Z0JBQ2IsSUFBSTtvQkFDQSxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7b0JBQ3hFLElBQUksS0FBSyxFQUFFO3dCQUNQLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUN4RSxJQUFJLFdBQVcsRUFBRTs0QkFDYixNQUFNLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ3RGLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7NEJBQ3JILE1BQU0scUJBQXFCLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFO2dDQUN6RCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFTLEVBQUUsZ0RBQUMsT0FBQSxVQUFVLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFBLEdBQUEsQ0FBQyxDQUFBOzRCQUMzRSxDQUFDLENBQUMsQ0FBQzs0QkFDSCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQzt5QkFDNUM7cUJBQ0o7b0JBQ0QsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO2lCQUNqQjtnQkFBQyxPQUFPLEtBQUssRUFBRTtvQkFDWixPQUFPLENBQUMsTUFBTSxFQUFFLENBQUE7aUJBQ25CO1lBQ0wsQ0FBQyxDQUFBLEVBQ0QsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQ25CLENBQUM7UUFDTixDQUFDO0tBQUE7SUFFSyxPQUFPLENBQUMsTUFBMEI7O1lBQ3BDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtnQkFDckIsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUMzQyxNQUFNLE9BQU8sR0FBRyxJQUFJLGlCQUFPLENBQUM7b0JBQ3hCLElBQUksa0NBQ0csY0FBYyxLQUNqQixJQUFJLEVBQUUsU0FBUyxHQUNsQjtvQkFDRCxJQUFJLEVBQUUsY0FBYyxDQUFDLElBQUk7aUJBQzVCLENBQUMsQ0FBQztnQkFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7Z0JBQ3ZGLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUFBO0NBQ0o7QUFwRUQsbUNBb0VDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9jdWF0cm9vY2hlbnRhL01hZ2ljU2hvcHBlci9tYWdpY3Nob3BwZXItbm9kZS9zcmMvbWljcm9rL2V2ZW50L2luZnJhc3RydWN0dXJlL3JhYmJpdC1tcS9SYWJiaXRNcUV2ZW50QnVzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbm5lY3Rpb24sIE1lc3NhZ2UsIEV4Y2hhbmdlLCBRdWV1ZSB9IGZyb20gJ2FtcXAtdHMnO1xuaW1wb3J0IE1lc3NhZ2VOYW1lIGZyb20gJy4uLy4uLy4uL2NvbW1vbi9tZXNzYWdlL01lc3NhZ2VOYW1lJztcbmltcG9ydCBMb2dnZXIgZnJvbSAnLi4vLi4vLi4vY29yZS9kb21haW4vTG9nZ2VyJztcbmltcG9ydCBXcmFwcGVyRXhlY3V0b3IgZnJvbSAnLi4vLi4vLi4vY29yZS9kb21haW4vV3JhcHBlckV4ZWN1dG9yJztcbmltcG9ydCBFeGVjdXRvciBmcm9tICcuLi8uLi8uLi9jb3JlL2luZnJhc3RydWN0dXJlL0V4ZWN1dG9yJztcbmltcG9ydCBEb21haW5FdmVudCBmcm9tICcuLi8uLi9kb21haW4vRG9tYWluRXZlbnQnO1xuaW1wb3J0IEV2ZW50QnVzIGZyb20gJy4uLy4uL2RvbWFpbi9FdmVudEJ1cyc7XG5pbXBvcnQgRXZlbnRTdWJzY3JpYmVyIGZyb20gJy4uLy4uL2RvbWFpbi9FdmVudFN1YnNjcmliZXInO1xuaW1wb3J0IFJhYmJpdE1xQ29uZmlnIGZyb20gJy4vUmFiYml0TXFDb25maWcnO1xuaW1wb3J0IHsgRXZlbnRKc29uRGVzZXJpYWxpemVyIH0gZnJvbSAnLi4vRXZlbnRKc29uRGVzZXJpYWxpemVyJztcbmltcG9ydCB7IE1hcHBlciB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9NYXBwZXInO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSYWJiaXRNcUV2ZW50YnVzIGltcGxlbWVudHMgRXZlbnRCdXMge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZXhlY3V0b3I6IEV4ZWN1dG9yPERvbWFpbkV2ZW50LCB2b2lkPjtcblxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29ubmVjdGlvbjogQ29ubmVjdGlvbjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGV4Y2hhbmdlOiBFeGNoYW5nZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHF1ZXVlOiBRdWV1ZTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBjb25maWc6IFJhYmJpdE1xQ29uZmlnLFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGRvbWFpbkV2ZW50U3Vic2NyaWJlck1hcHBlcjogTWFwcGVyPE1lc3NhZ2VOYW1lLCBBcnJheTxFdmVudFN1YnNjcmliZXI8RG9tYWluRXZlbnQ+Pj4sXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzZXJpYWxpemVyOiBFdmVudEpzb25EZXNlcmlhbGl6ZXIsXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nZ2VyOiBMb2dnZXIsXG4gICAgICAgIGV4ZWN1dG9yczogV3JhcHBlckV4ZWN1dG9yPERvbWFpbkV2ZW50LCB2b2lkPltdID0gW10sXG4gICAgKSB7XG4gICAgICAgIHRoaXMuZXhlY3V0b3IgPSBuZXcgRXhlY3V0b3I8RG9tYWluRXZlbnQsIHZvaWQ+KGV4ZWN1dG9ycyk7XG5cbiAgICAgICAgdGhpcy5jb25uZWN0aW9uID0gbmV3IENvbm5lY3Rpb24oYGFtcXA6Ly8ke2NvbmZpZy51c2VyfToke2NvbmZpZy5wYXNzd29yZH1AJHtjb25maWcuaG9zdH1gKTtcbiAgICAgICAgdGhpcy5leGNoYW5nZSA9IHRoaXMuY29ubmVjdGlvbi5kZWNsYXJlRXhjaGFuZ2UoY29uZmlnLmV4Y2hhbmdlLCAnZmFub3V0JywgeyBkdXJhYmxlOiBmYWxzZSB9KTtcbiAgICAgICAgdGhpcy5xdWV1ZSA9IHRoaXMuY29ubmVjdGlvbi5kZWNsYXJlUXVldWUoY29uZmlnLnF1ZXVlKTtcbiAgICB9XG5cbiAgICBhc3luYyBzdGFydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCF0aGlzLmRlc2VyaWFsaXplcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSYWJiaXRNcUV2ZW50QnVzIGhhcyBub3QgYmVpbmcgcHJvcGVybHkgaW5pdGlhbGl6ZWQsIGRlc2VyaWFsaXplciBpcyBtaXNzaW5nJyk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uY29tcGxldGVDb25maWd1cmF0aW9uKCk7XG5cbiAgICAgICAgYXdhaXQgdGhpcy5xdWV1ZS5iaW5kKHRoaXMuZXhjaGFuZ2UpO1xuICAgICAgICBhd2FpdCB0aGlzLnF1ZXVlLnN0b3BDb25zdW1lcigpO1xuICAgICAgICBhd2FpdCB0aGlzLnF1ZXVlLmFjdGl2YXRlQ29uc3VtZXIoXG4gICAgICAgICAgICBhc3luYyhtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXZlbnQgPSB0aGlzLmRlc2VyaWFsaXplci5kZXNlcmlhbGl6ZShtZXNzYWdlLmNvbnRlbnQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3Vic2NyaWJlcnMgPSB0aGlzLmRvbWFpbkV2ZW50U3Vic2NyaWJlck1hcHBlci5zZWFyY2goZXZlbnQubmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3Vic2NyaWJlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJzY3JpYmVyc05hbWVzID0gc3Vic2NyaWJlcnMubWFwKChzdWJzY3JpYmVyKSA9PiBzdWJzY3JpYmVyLmNvbnN0cnVjdG9yLm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmluZm8oYFtSYWJiaXRNcUV2ZW50QnVzXSBNZXNzYWdlIHByb2Nlc3NlZDogJHtldmVudC5uYW1lLnRvU3RyaW5nKCl9IGJ5ICR7c3Vic2NyaWJlcnNOYW1lcy5qb2luKCcsICcpfWApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YnNjcmliZXJzRXhlY3V0aW9ucyA9IHN1YnNjcmliZXJzLm1hcCgoc3Vic2NyaWJlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5leGVjdXRvci5ydW4oZXZlbnQsIGFzeW5jICgpID0+IHN1YnNjcmliZXIuZGlzcGF0Y2goZXZlbnQpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHN1YnNjcmliZXJzRXhlY3V0aW9ucyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5hY2soKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnJlamVjdCgpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgbm9BY2s6IGZhbHNlIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc3luYyBwdWJsaXNoKGV2ZW50czogQXJyYXk8RG9tYWluRXZlbnQ+KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGV2ZW50cy5mb3JFYWNoKChldmVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXZlbnRQcmltaXRpdmUgPSBldmVudC50b1ByaW1pdGl2ZSgpO1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IG5ldyBNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLmV2ZW50UHJpbWl0aXZlLFxuICAgICAgICAgICAgICAgICAgICBtZXRhOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBtZXRhOiBldmVudFByaW1pdGl2ZS5tZXRhLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKGBbUmFiYml0TXFFdmVudEJ1c10gRXZlbnQgdG8gYmUgcHVibGlzaGVkOiAke2V2ZW50Lm5hbWUudG9TdHJpbmcoKX1gKTtcbiAgICAgICAgICAgIHRoaXMuZXhjaGFuZ2Uuc2VuZChtZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl0sInZlcnNpb24iOjN9