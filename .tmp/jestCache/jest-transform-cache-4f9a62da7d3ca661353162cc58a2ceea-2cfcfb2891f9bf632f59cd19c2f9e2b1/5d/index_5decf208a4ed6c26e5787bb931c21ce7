daf43628a7f1dfae1ee3d814997a51aa
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const doctrine_1 = __importDefault(require("doctrine"));
const fs_1 = __importDefault(require("fs"));
const glob_1 = __importDefault(require("glob"));
const lodash_mergewith_1 = __importDefault(require("lodash.mergewith"));
const path_1 = __importDefault(require("path"));
const yaml_1 = __importDefault(require("yaml"));
class OpenApi {
    constructor(config) {
        this.config = config;
        this.globFilesMatches = (baseDir, filesPattern, excludedFolder = OpenApi.DEFAULT_EXCLUDED_FOLDER) => {
            try {
                const files = glob_1.default.sync(path_1.default.resolve(baseDir, filesPattern), OpenApi.DEFAULT_GLOB_OPTIONS);
                return files.filter((file) => !file.includes(excludedFolder));
            }
            catch (error) {
                throw new Error('Error Glob Files');
            }
        };
        this.getComments = (text) => {
            const comments = text.match(OpenApi.COMMENTS_PATTERN);
            if (comments) {
                const filterComments = comments.filter((comment) => comment.match(OpenApi.BREAK_LINE));
                return filterComments.map((comment) => comment.trim());
            }
            return [];
        };
    }
    readFile(filePath) {
        return fs_1.default.readFileSync(filePath).toString();
    }
    readFiles(files) {
        if (!files || !Array.isArray(files)) {
            return [];
        }
        return files.map((file) => this.readFile(file));
    }
    getOnlyComments(fileContents = []) {
        if (!Array.isArray(fileContents)) {
            return [];
        }
        const comments = fileContents.map((comment) => {
            const trimedComments = comment.trim();
            return this.getComments(trimedComments);
        });
        return [].concat(...comments).filter((comment) => (comment[0] === '/' && comment[1] !== '/'));
    }
    jsdocInfo(comments) {
        if (!comments || !Array.isArray(comments)) {
            return [];
        }
        return comments.map((comment) => {
            const jsDocComment = doctrine_1.default.parse(comment, { unwrap: true });
            return jsDocComment;
        });
    }
    parseYamlComments(jsDoc) {
        const yamlComments = [];
        for (const doc of jsDoc) {
            for (const tag of doc.tags) {
                if (tag.title === 'openapi') {
                    yamlComments.push(tag.description);
                }
            }
        }
        return yamlComments;
    }
    parseJsonCommentsFromYaml(yamlComments) {
        const jsons = [];
        for (const doc of yamlComments) {
            const parsed = yaml_1.default.parseDocument(doc);
            const anchors = parsed.anchors.getNames();
            if (anchors.length) {
                throw new Error('Error parsing YAML comments');
            }
            else if (parsed.errors && parsed.errors.length) {
                throw new Error('Error parsing YAML comments');
            }
            else {
                jsons.push(parsed.toJSON());
            }
        }
        return jsons;
    }
    mergeDeep(first, second) {
        return (0, lodash_mergewith_1.default)({}, first, second, (x, y) => (y === null ? x : undefined));
    }
    removeEmptyKeys(obj) {
        if (!obj) {
            return {};
        }
        Object.keys(obj).forEach((key) => {
            if (obj[key] === undefined) {
                delete obj[key];
            }
        });
        return obj;
    }
    buildOpenApiObject(jsonComments) {
        const openApi = this.removeEmptyKeys({
            openapi: '3.0.0',
            info: this.config.info,
            servers: this.config.servers,
            paths: this.config.paths || {},
            components: Object.assign(Object.assign({}, this.config.components), { schemas: this.config.components.schemas || {} }),
            security: this.config.security,
            tags: this.config.tags,
            externalDocs: this.config.externalDocs,
        });
        for (const jsonComment of jsonComments) {
            for (const key of Object.keys(jsonComment)) {
                if (key.startsWith('/')) {
                    openApi.paths[key] = this.mergeDeep(openApi.paths[key], jsonComment[key]);
                }
                else {
                    openApi.components.schemas[key] = jsonComment[key];
                }
            }
        }
        return openApi;
    }
    generateDocs() {
        const files = this.globFilesMatches(this.config.baseDir, this.config.filesPattern);
        const fileContents = this.readFiles(files);
        const comments = this.getOnlyComments(fileContents);
        const jsDocInfo = this.jsdocInfo(comments);
        const yamlComments = this.parseYamlComments(jsDocInfo);
        const jsonComments = this.parseJsonCommentsFromYaml(yamlComments);
        return this.buildOpenApiObject(jsonComments);
    }
}
exports.default = OpenApi;
OpenApi.DEFAULT_EXCLUDED_FOLDER = 'node_modules';
OpenApi.DEFAULT_GLOB_OPTIONS = { ignore: '**/node_modules/**' };
// eslint-disable-next-line prefer-named-capture-group
OpenApi.COMMENTS_PATTERN = /((\/\*\*+[\s\S]*?\*\/)|(\/\*+.*\*\/)|^\/\/.*?[\r\n])[\r\n]*/gm;
OpenApi.BREAK_LINE = /\n/g;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3NyYy9taWNyb2svZG9jcy9vcGVuYXBpL2luZGV4LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsd0RBQWdDO0FBQ2hDLDRDQUFvQjtBQUNwQixnREFBd0I7QUFDeEIsd0VBQXlDO0FBV3pDLGdEQUF3QjtBQUN4QixnREFBd0I7QUFleEIsTUFBcUIsT0FBTztJQU94QixZQUNxQixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBSWxDLHFCQUFnQixHQUFHLENBQ3ZCLE9BQWUsRUFDZixZQUFvQixFQUNwQixpQkFBeUIsT0FBTyxDQUFDLHVCQUF1QixFQUMxRCxFQUFFO1lBQ0EsSUFBSTtnQkFDQSxNQUFNLEtBQUssR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxFQUFFLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO2dCQUMzRixPQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO2FBQ2pFO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ1osTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO2FBQ3ZDO1FBQ0wsQ0FBQyxDQUFBO1FBY08sZ0JBQVcsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQzNCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDdEQsSUFBSSxRQUFRLEVBQUU7Z0JBQ1YsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDdkYsT0FBTyxj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UUFBUSxDQUFDLENBQUE7UUFDMUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsQ0FBQTtRQUNqRSxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUNqRCxDQUFDOztBQXBKTCwwQkFxSkM7QUFwSmtCLCtCQUF1QixHQUFHLGNBQWMsQ0FBQztBQUN6Qyw0QkFBb0IsR0FBRyxFQUFFLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxDQUFDO0FBQ3ZFLHNEQUFzRDtBQUN2Qyx3QkFBZ0IsR0FBRywrREFBK0QsQ0FBQztBQUNuRixrQkFBVSxHQUFHLEtBQUssQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY3VhdHJvb2NoZW50YS9NYWdpY1Nob3BwZXIvbWFnaWNzaG9wcGVyLW5vZGUvc3JjL21pY3Jvay9kb2NzL29wZW5hcGkvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGRvY3RyaW5lIGZyb20gJ2RvY3RyaW5lJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBtZXJnZVdpdGggZnJvbSAnbG9kYXNoLm1lcmdld2l0aCc7XG5pbXBvcnQgeyBPcGVuQVBJT2JqZWN0IH0gZnJvbSAnb3BlbmFwaTMtdHMnO1xuaW1wb3J0IHtcbiAgICBDb21wb25lbnRzT2JqZWN0LFxuICAgIEV4dGVybmFsRG9jdW1lbnRhdGlvbk9iamVjdCxcbiAgICBJbmZvT2JqZWN0LFxuICAgIFBhdGhzT2JqZWN0LFxuICAgIFNlY3VyaXR5UmVxdWlyZW1lbnRPYmplY3QsXG4gICAgU2VydmVyT2JqZWN0LFxuICAgIFRhZ09iamVjdCxcbn0gZnJvbSAnb3BlbmFwaTMtdHMvc3JjL21vZGVsL09wZW5BcGknO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgWUFNTCBmcm9tICd5YW1sJztcblxuZXhwb3J0IHR5cGUgT3BlbkFwaUNvbmZpZyA9IHtcbiAgICBiYXNlRGlyOiBzdHJpbmcsXG4gICAgZmlsZXNQYXR0ZXJuOiBzdHJpbmcsXG5cbiAgICBpbmZvOiBJbmZvT2JqZWN0O1xuICAgIHNlcnZlcnM/OiBTZXJ2ZXJPYmplY3RbXTtcbiAgICBwYXRocz86IFBhdGhzT2JqZWN0O1xuICAgIGNvbXBvbmVudHM/OiBDb21wb25lbnRzT2JqZWN0O1xuICAgIHNlY3VyaXR5PzogU2VjdXJpdHlSZXF1aXJlbWVudE9iamVjdFtdO1xuICAgIHRhZ3M/OiBUYWdPYmplY3RbXTtcbiAgICBleHRlcm5hbERvY3M/OiBFeHRlcm5hbERvY3VtZW50YXRpb25PYmplY3Q7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9wZW5BcGkge1xuICAgIHByaXZhdGUgc3RhdGljIERFRkFVTFRfRVhDTFVERURfRk9MREVSID0gJ25vZGVfbW9kdWxlcyc7XG4gICAgcHJpdmF0ZSBzdGF0aWMgREVGQVVMVF9HTE9CX09QVElPTlMgPSB7IGlnbm9yZTogJyoqL25vZGVfbW9kdWxlcy8qKicgfTtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLW5hbWVkLWNhcHR1cmUtZ3JvdXBcbiAgICBwcml2YXRlIHN0YXRpYyBDT01NRU5UU19QQVRURVJOID0gLygoXFwvXFwqXFwqK1tcXHNcXFNdKj9cXCpcXC8pfChcXC9cXCorLipcXCpcXC8pfF5cXC9cXC8uKj9bXFxyXFxuXSlbXFxyXFxuXSovZ207XG4gICAgcHJpdmF0ZSBzdGF0aWMgQlJFQUtfTElORSA9IC9cXG4vZztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogT3BlbkFwaUNvbmZpZyxcbiAgICApIHtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdsb2JGaWxlc01hdGNoZXMgPSAoXG4gICAgICAgIGJhc2VEaXI6IHN0cmluZyxcbiAgICAgICAgZmlsZXNQYXR0ZXJuOiBzdHJpbmcsXG4gICAgICAgIGV4Y2x1ZGVkRm9sZGVyOiBzdHJpbmcgPSBPcGVuQXBpLkRFRkFVTFRfRVhDTFVERURfRk9MREVSLFxuICAgICkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZXMgPSBnbG9iLnN5bmMocGF0aC5yZXNvbHZlKGJhc2VEaXIsIGZpbGVzUGF0dGVybiksIE9wZW5BcGkuREVGQVVMVF9HTE9CX09QVElPTlMpO1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVzLmZpbHRlcigoZmlsZSkgPT4gIWZpbGUuaW5jbHVkZXMoZXhjbHVkZWRGb2xkZXIpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgR2xvYiBGaWxlcycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZWFkRmlsZShmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlYWRGaWxlcyhmaWxlczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG4gICAgICAgIGlmICghZmlsZXMgfHwgIUFycmF5LmlzQXJyYXkoZmlsZXMpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVzLm1hcCgoZmlsZSkgPT4gdGhpcy5yZWFkRmlsZShmaWxlKSk7XG4gICAgfVxuXG5cbiAgICBwcml2YXRlIGdldENvbW1lbnRzID0gKHRleHQpID0+IHtcbiAgICAgICAgY29uc3QgY29tbWVudHMgPSB0ZXh0Lm1hdGNoKE9wZW5BcGkuQ09NTUVOVFNfUEFUVEVSTik7XG4gICAgICAgIGlmIChjb21tZW50cykge1xuICAgICAgICAgICAgY29uc3QgZmlsdGVyQ29tbWVudHMgPSBjb21tZW50cy5maWx0ZXIoKGNvbW1lbnQpID0+IGNvbW1lbnQubWF0Y2goT3BlbkFwaS5CUkVBS19MSU5FKSk7XG4gICAgICAgICAgICByZXR1cm4gZmlsdGVyQ29tbWVudHMubWFwKChjb21tZW50KSA9PiBjb21tZW50LnRyaW0oKSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH07XG5cbiAgICBwcml2YXRlIGdldE9ubHlDb21tZW50cyhmaWxlQ29udGVudHM6IHN0cmluZ1tdID0gW10pIHtcbiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGZpbGVDb250ZW50cykpIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb21tZW50cyA9IGZpbGVDb250ZW50cy5tYXAoKGNvbW1lbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRyaW1lZENvbW1lbnRzID0gY29tbWVudC50cmltKCk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRDb21tZW50cyh0cmltZWRDb21tZW50cyk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gW10uY29uY2F0KC4uLmNvbW1lbnRzKS5maWx0ZXIoKGNvbW1lbnQpID0+IChjb21tZW50WzBdID09PSAnLycgJiYgY29tbWVudFsxXSAhPT0gJy8nKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBqc2RvY0luZm8oY29tbWVudHMpOiBhbnlbXSB7XG4gICAgICAgIGlmICghY29tbWVudHMgfHwgIUFycmF5LmlzQXJyYXkoY29tbWVudHMpKSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbW1lbnRzLm1hcCgoY29tbWVudCkgPT4ge1xuICAgICAgICAgICAgY29uc3QganNEb2NDb21tZW50ID0gZG9jdHJpbmUucGFyc2UoY29tbWVudCwgeyB1bndyYXA6IHRydWUgfSk7XG4gICAgICAgICAgICByZXR1cm4ganNEb2NDb21tZW50O1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlWWFtbENvbW1lbnRzKGpzRG9jOiBhbnlbXSkge1xuICAgICAgICBjb25zdCB5YW1sQ29tbWVudHMgPSBbXVxuICAgICAgICBmb3IgKGNvbnN0IGRvYyBvZiBqc0RvYykge1xuICAgICAgICAgICAgZm9yIChjb25zdCB0YWcgb2YgZG9jLnRhZ3MpIHtcbiAgICAgICAgICAgICAgICBpZiAodGFnLnRpdGxlID09PSAnb3BlbmFwaScpIHtcbiAgICAgICAgICAgICAgICAgICAgeWFtbENvbW1lbnRzLnB1c2godGFnLmRlc2NyaXB0aW9uKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geWFtbENvbW1lbnRzO1xuICAgIH1cblxuICAgIHByaXZhdGUgcGFyc2VKc29uQ29tbWVudHNGcm9tWWFtbCh5YW1sQ29tbWVudHMpOiBvYmplY3RbXSB7XG4gICAgICAgIGNvbnN0IGpzb25zID0gW11cbiAgICAgICAgZm9yIChjb25zdCBkb2Mgb2YgeWFtbENvbW1lbnRzKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJzZWQgPSBZQU1MLnBhcnNlRG9jdW1lbnQoZG9jKTtcblxuICAgICAgICAgICAgY29uc3QgYW5jaG9ycyA9IHBhcnNlZC5hbmNob3JzLmdldE5hbWVzKCk7XG4gICAgICAgICAgICBpZiAoYW5jaG9ycy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIHBhcnNpbmcgWUFNTCBjb21tZW50cycpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChwYXJzZWQuZXJyb3JzICYmIHBhcnNlZC5lcnJvcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBwYXJzaW5nIFlBTUwgY29tbWVudHMnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAganNvbnMucHVzaChwYXJzZWQudG9KU09OKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBqc29ucztcbiAgICB9XG5cbiAgICBwcml2YXRlIG1lcmdlRGVlcChmaXJzdCwgc2Vjb25kKSB7XG4gICAgICAgIHJldHVybiBtZXJnZVdpdGgoe30sIGZpcnN0LCBzZWNvbmQsICh4LCB5KSA9PiAoeSA9PT0gbnVsbCA/IHggOiB1bmRlZmluZWQpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbW92ZUVtcHR5S2V5cyhvYmopIHtcbiAgICAgICAgaWYgKCFvYmopIHtcbiAgICAgICAgICAgIHJldHVybiB7fTtcbiAgICAgICAgfVxuICAgICAgICBPYmplY3Qua2V5cyhvYmopLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgaWYgKG9ialtrZXldID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgb2JqW2tleV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgIH1cblxuICAgIHByaXZhdGUgYnVpbGRPcGVuQXBpT2JqZWN0KGpzb25Db21tZW50czogb2JqZWN0W10pOiBPcGVuQVBJT2JqZWN0IHtcbiAgICAgICAgY29uc3Qgb3BlbkFwaTogT3BlbkFQSU9iamVjdCA9IHRoaXMucmVtb3ZlRW1wdHlLZXlzKHtcbiAgICAgICAgICAgIG9wZW5hcGk6ICczLjAuMCcsXG4gICAgICAgICAgICBpbmZvOiB0aGlzLmNvbmZpZy5pbmZvLFxuICAgICAgICAgICAgc2VydmVyczogdGhpcy5jb25maWcuc2VydmVycyxcbiAgICAgICAgICAgIHBhdGhzOiB0aGlzLmNvbmZpZy5wYXRocyB8fCB7fSxcbiAgICAgICAgICAgIGNvbXBvbmVudHM6IHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLmNvbmZpZy5jb21wb25lbnRzLFxuICAgICAgICAgICAgICAgIHNjaGVtYXM6IHRoaXMuY29uZmlnLmNvbXBvbmVudHMuc2NoZW1hcyB8fCB7fSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZWN1cml0eTogdGhpcy5jb25maWcuc2VjdXJpdHksXG4gICAgICAgICAgICB0YWdzOiB0aGlzLmNvbmZpZy50YWdzLFxuICAgICAgICAgICAgZXh0ZXJuYWxEb2NzOiB0aGlzLmNvbmZpZy5leHRlcm5hbERvY3MsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QganNvbkNvbW1lbnQgb2YganNvbkNvbW1lbnRzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhqc29uQ29tbWVudCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgICAgICAgICAgICAgICAgICBvcGVuQXBpLnBhdGhzW2tleV0gPSB0aGlzLm1lcmdlRGVlcChvcGVuQXBpLnBhdGhzW2tleV0sIGpzb25Db21tZW50W2tleV0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wZW5BcGkuY29tcG9uZW50cy5zY2hlbWFzW2tleV0gPSBqc29uQ29tbWVudFtrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcGVuQXBpO1xuICAgIH1cblxuICAgIGdlbmVyYXRlRG9jcygpOiBPcGVuQVBJT2JqZWN0IHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdsb2JGaWxlc01hdGNoZXModGhpcy5jb25maWcuYmFzZURpciwgdGhpcy5jb25maWcuZmlsZXNQYXR0ZXJuKTtcbiAgICAgICAgY29uc3QgZmlsZUNvbnRlbnRzID0gdGhpcy5yZWFkRmlsZXMoZmlsZXMpO1xuICAgICAgICBjb25zdCBjb21tZW50cyA9IHRoaXMuZ2V0T25seUNvbW1lbnRzKGZpbGVDb250ZW50cyk7XG4gICAgICAgIGNvbnN0IGpzRG9jSW5mbyA9IHRoaXMuanNkb2NJbmZvKGNvbW1lbnRzKVxuICAgICAgICBjb25zdCB5YW1sQ29tbWVudHMgPSB0aGlzLnBhcnNlWWFtbENvbW1lbnRzKGpzRG9jSW5mbylcbiAgICAgICAgY29uc3QganNvbkNvbW1lbnRzID0gdGhpcy5wYXJzZUpzb25Db21tZW50c0Zyb21ZYW1sKHlhbWxDb21tZW50cylcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRPcGVuQXBpT2JqZWN0KGpzb25Db21tZW50cyk7XG4gICAgfVxufVxuIl0sInZlcnNpb24iOjN9