fcc1ae6dd1dcb07fe5155608c6b88a28
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const glob_1 = __importDefault(require("glob"));
const lodash_mergewith_1 = __importDefault(require("lodash.mergewith"));
const path_1 = __importDefault(require("path"));
const GetOnlyComments_1 = require("./consumers/GetOnlyComments");
const jsDocInfo_1 = require("./consumers/jsDocInfo");
const parseJsonCommentsFromYaml_1 = require("./consumers/parseJsonCommentsFromYaml");
const parseYamlComments_1 = require("./consumers/parseYamlComments");
class OpenApi {
    constructor(config) {
        this.config = config;
        this.globFilesMatches = (baseDir, filesPattern, excludedFolder = OpenApi.DEFAULT_EXCLUDED_FOLDER) => {
            try {
                const files = glob_1.default.sync(path_1.default.resolve(baseDir, filesPattern), OpenApi.DEFAULT_GLOB_OPTIONS);
                return files.filter((file) => !file.includes(excludedFolder));
            }
            catch (error) {
                throw new Error('Error Glob Files');
            }
        };
    }
    readFile(filePath) {
        return fs_1.default.readFileSync(filePath).toString();
    }
    readFiles(files) {
        if (!files || !Array.isArray(files)) {
            return [];
        }
        return files.map((file) => this.readFile(file));
    }
    mergeDeep(first, second) {
        return (0, lodash_mergewith_1.default)({}, first, second, (x, y) => (y === null ? x : undefined));
    }
    removeEmptyKeys(obj) {
        if (!obj) {
            return {};
        }
        Object.keys(obj).forEach((key) => {
            if (obj[key] === undefined) {
                delete obj[key];
            }
        });
        return obj;
    }
    generateDocs() {
        const files = this.globFilesMatches(this.config.baseDir, this.config.filesPattern);
        const fileContents = this.readFiles(files);
        const comments = (0, GetOnlyComments_1.getOnlyComments)(fileContents);
        const jsDocInfo = (0, jsDocInfo_1.jsdocInfo)()(comments);
        const yamlComments = (0, parseYamlComments_1.parseYamlComments)(jsDocInfo);
        const jsonComments = (0, parseJsonCommentsFromYaml_1.parseJsonCommentsFromYaml)(yamlComments);
        const openApi = this.removeEmptyKeys({
            openapi: '3.0.0',
            info: this.config.info,
            servers: this.config.servers,
            paths: this.config.paths || {},
            components: Object.assign(Object.assign({}, this.config.components), { schemas: this.config.components.schemas || {} }),
            security: this.config.security,
            tags: this.config.tags,
            externalDocs: this.config.externalDocs,
        });
        for (const jsonComment of jsonComments) {
            for (const key of Object.keys(jsonComment)) {
                if (key.startsWith('/')) {
                    openApi.paths[key] = this.mergeDeep(openApi.paths[key], jsonComment[key]);
                }
                else {
                    openApi.components.schemas[key] = jsonComment[key];
                }
            }
        }
        return openApi;
    }
}
exports.default = OpenApi;
OpenApi.DEFAULT_EXCLUDED_FOLDER = 'node_modules';
OpenApi.DEFAULT_GLOB_OPTIONS = { ignore: '**/node_modules/**' };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2N1YXRyb29jaGVudGEvTWFnaWNTaG9wcGVyL21hZ2ljc2hvcHBlci1ub2RlL3NyYy9taWNyb2svZG9jcy9vcGVuYXBpL2luZGV4LnRzIiwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsNENBQW9CO0FBQ3BCLGdEQUF3QjtBQUN4Qix3RUFBeUM7QUFXekMsZ0RBQXdCO0FBQ3hCLGlFQUE4RDtBQUM5RCxxREFBa0Q7QUFDbEQscUZBQWtGO0FBQ2xGLHFFQUFrRTtBQWVsRSxNQUFxQixPQUFPO0lBSXhCLFlBQ3FCLE1BQXFCO1FBQXJCLFdBQU0sR0FBTixNQUFNLENBQWU7UUFJMUMscUJBQWdCLEdBQUcsQ0FDZixPQUFlLEVBQ2YsWUFBb0IsRUFDcEIsaUJBQXlCLE9BQU8sQ0FBQyx1QkFBdUIsRUFDMUQsRUFBRTtZQUNBLElBQUk7Z0JBQ0EsTUFBTSxLQUFLLEdBQUcsY0FBSSxDQUFDLElBQUksQ0FBQyxjQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsRUFBRSxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQztnQkFDM0YsT0FBTyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQzthQUNqRTtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUN2QztRQUNMLENBQUMsQ0FBQTtJQWJELENBQUM7SUFlRCxRQUFRLENBQUMsUUFBZ0I7UUFDckIsT0FBTyxZQUFFLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFFRCxTQUFTLENBQUMsS0FBZTtRQUNyQixJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNqQyxPQUFPLEVBQUUsQ0FBQztTQUNiO1FBQ0QsT0FBTyxLQUFL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LENBQUM7SUFDbkIsQ0FBQzs7QUFsRkwsMEJBbUZDO0FBbEZrQiwrQkFBdUIsR0FBRyxjQUFjLENBQUM7QUFDekMsNEJBQW9CLEdBQUcsRUFBRSxNQUFNLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvY3VhdHJvb2NoZW50YS9NYWdpY1Nob3BwZXIvbWFnaWNzaG9wcGVyLW5vZGUvc3JjL21pY3Jvay9kb2NzL29wZW5hcGkvaW5kZXgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBnbG9iIGZyb20gJ2dsb2InO1xuaW1wb3J0IG1lcmdlV2l0aCBmcm9tICdsb2Rhc2gubWVyZ2V3aXRoJztcbmltcG9ydCB7IE9wZW5BUElPYmplY3QgfSBmcm9tICdvcGVuYXBpMy10cyc7XG5pbXBvcnQge1xuICAgIENvbXBvbmVudHNPYmplY3QsXG4gICAgRXh0ZXJuYWxEb2N1bWVudGF0aW9uT2JqZWN0LFxuICAgIEluZm9PYmplY3QsXG4gICAgUGF0aHNPYmplY3QsXG4gICAgU2VjdXJpdHlSZXF1aXJlbWVudE9iamVjdCxcbiAgICBTZXJ2ZXJPYmplY3QsXG4gICAgVGFnT2JqZWN0LFxufSBmcm9tICdvcGVuYXBpMy10cy9zcmMvbW9kZWwvT3BlbkFwaSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldE9ubHlDb21tZW50cyB9IGZyb20gJy4vY29uc3VtZXJzL0dldE9ubHlDb21tZW50cyc7XG5pbXBvcnQgeyBqc2RvY0luZm8gfSBmcm9tICcuL2NvbnN1bWVycy9qc0RvY0luZm8nO1xuaW1wb3J0IHsgcGFyc2VKc29uQ29tbWVudHNGcm9tWWFtbCB9IGZyb20gJy4vY29uc3VtZXJzL3BhcnNlSnNvbkNvbW1lbnRzRnJvbVlhbWwnO1xuaW1wb3J0IHsgcGFyc2VZYW1sQ29tbWVudHMgfSBmcm9tICcuL2NvbnN1bWVycy9wYXJzZVlhbWxDb21tZW50cyc7XG5cbmV4cG9ydCB0eXBlIE9wZW5BcGlDb25maWcgPSB7XG4gICAgYmFzZURpcjogc3RyaW5nLFxuICAgIGZpbGVzUGF0dGVybjogc3RyaW5nLFxuXG4gICAgaW5mbzogSW5mb09iamVjdDtcbiAgICBzZXJ2ZXJzPzogU2VydmVyT2JqZWN0W107XG4gICAgcGF0aHM/OiBQYXRoc09iamVjdDtcbiAgICBjb21wb25lbnRzPzogQ29tcG9uZW50c09iamVjdDtcbiAgICBzZWN1cml0eT86IFNlY3VyaXR5UmVxdWlyZW1lbnRPYmplY3RbXTtcbiAgICB0YWdzPzogVGFnT2JqZWN0W107XG4gICAgZXh0ZXJuYWxEb2NzPzogRXh0ZXJuYWxEb2N1bWVudGF0aW9uT2JqZWN0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBPcGVuQXBpIHtcbiAgICBwcml2YXRlIHN0YXRpYyBERUZBVUxUX0VYQ0xVREVEX0ZPTERFUiA9ICdub2RlX21vZHVsZXMnO1xuICAgIHByaXZhdGUgc3RhdGljIERFRkFVTFRfR0xPQl9PUFRJT05TID0geyBpZ25vcmU6ICcqKi9ub2RlX21vZHVsZXMvKionIH07XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IE9wZW5BcGlDb25maWcsXG4gICAgKSB7XG4gICAgfVxuXG4gICAgZ2xvYkZpbGVzTWF0Y2hlcyA9IChcbiAgICAgICAgYmFzZURpcjogc3RyaW5nLFxuICAgICAgICBmaWxlc1BhdHRlcm46IHN0cmluZyxcbiAgICAgICAgZXhjbHVkZWRGb2xkZXI6IHN0cmluZyA9IE9wZW5BcGkuREVGQVVMVF9FWENMVURFRF9GT0xERVIsXG4gICAgKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IGdsb2Iuc3luYyhwYXRoLnJlc29sdmUoYmFzZURpciwgZmlsZXNQYXR0ZXJuKSwgT3BlbkFwaS5ERUZBVUxUX0dMT0JfT1BUSU9OUyk7XG4gICAgICAgICAgICByZXR1cm4gZmlsZXMuZmlsdGVyKChmaWxlKSA9PiAhZmlsZS5pbmNsdWRlcyhleGNsdWRlZEZvbGRlcikpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBHbG9iIEZpbGVzJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZWFkRmlsZShmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRGaWxlU3luYyhmaWxlUGF0aCkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICByZWFkRmlsZXMoZmlsZXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xuICAgICAgICBpZiAoIWZpbGVzIHx8ICFBcnJheS5pc0FycmF5KGZpbGVzKSkge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmaWxlcy5tYXAoKGZpbGUpID0+IHRoaXMucmVhZEZpbGUoZmlsZSkpO1xuICAgIH1cblxuICAgIG1lcmdlRGVlcChmaXJzdCwgc2Vjb25kKSB7XG4gICAgICAgIHJldHVybiBtZXJnZVdpdGgoe30sIGZpcnN0LCBzZWNvbmQsICh4LCB5KSA9PiAoeSA9PT0gbnVsbCA/IHggOiB1bmRlZmluZWQpKTtcbiAgICB9XG5cbiAgICByZW1vdmVFbXB0eUtleXMob2JqKSB7XG4gICAgICAgIGlmICghb2JqKSB7XG4gICAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIH1cbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChvYmpba2V5XSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIG9ialtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZURvY3MoKTogT3BlbkFQSU9iamVjdCB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5nbG9iRmlsZXNNYXRjaGVzKHRoaXMuY29uZmlnLmJhc2VEaXIsIHRoaXMuY29uZmlnLmZpbGVzUGF0dGVybik7XG4gICAgICAgIGNvbnN0IGZpbGVDb250ZW50cyA9IHRoaXMucmVhZEZpbGVzKGZpbGVzKTtcbiAgICAgICAgY29uc3QgY29tbWVudHMgPSBnZXRPbmx5Q29tbWVudHMoZmlsZUNvbnRlbnRzKTtcbiAgICAgICAgY29uc3QganNEb2NJbmZvID0ganNkb2NJbmZvKCkoY29tbWVudHMpXG4gICAgICAgIGNvbnN0IHlhbWxDb21tZW50cyA9IHBhcnNlWWFtbENvbW1lbnRzKGpzRG9jSW5mbylcbiAgICAgICAgY29uc3QganNvbkNvbW1lbnRzID0gcGFyc2VKc29uQ29tbWVudHNGcm9tWWFtbCh5YW1sQ29tbWVudHMpXG5cbiAgICAgICAgY29uc3Qgb3BlbkFwaTogT3BlbkFQSU9iamVjdCA9IHRoaXMucmVtb3ZlRW1wdHlLZXlzKHtcbiAgICAgICAgICAgIG9wZW5hcGk6ICczLjAuMCcsXG4gICAgICAgICAgICBpbmZvOiB0aGlzLmNvbmZpZy5pbmZvLFxuICAgICAgICAgICAgc2VydmVyczogdGhpcy5jb25maWcuc2VydmVycyxcbiAgICAgICAgICAgIHBhdGhzOiB0aGlzLmNvbmZpZy5wYXRocyB8fCB7fSxcbiAgICAgICAgICAgIGNvbXBvbmVudHM6IHtcbiAgICAgICAgICAgICAgICAuLi50aGlzLmNvbmZpZy5jb21wb25lbnRzLFxuICAgICAgICAgICAgICAgIHNjaGVtYXM6IHRoaXMuY29uZmlnLmNvbXBvbmVudHMuc2NoZW1hcyB8fCB7fSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZWN1cml0eTogdGhpcy5jb25maWcuc2VjdXJpdHksXG4gICAgICAgICAgICB0YWdzOiB0aGlzLmNvbmZpZy50YWdzLFxuICAgICAgICAgICAgZXh0ZXJuYWxEb2NzOiB0aGlzLmNvbmZpZy5leHRlcm5hbERvY3MsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZvciAoY29uc3QganNvbkNvbW1lbnQgb2YganNvbkNvbW1lbnRzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhqc29uQ29tbWVudCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoa2V5LnN0YXJ0c1dpdGgoJy8nKSkge1xuICAgICAgICAgICAgICAgICAgICBvcGVuQXBpLnBhdGhzW2tleV0gPSB0aGlzLm1lcmdlRGVlcChvcGVuQXBpLnBhdGhzW2tleV0sIGpzb25Db21tZW50W2tleV0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9wZW5BcGkuY29tcG9uZW50cy5zY2hlbWFzW2tleV0gPSBqc29uQ29tbWVudFtrZXldO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcGVuQXBpO1xuICAgIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==